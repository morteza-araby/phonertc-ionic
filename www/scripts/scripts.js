"use strict";angular.module("config",[]).constant("ENV",{name:"production",apiEndpoint:"http://api.yoursite.com/"}),angular.module("phonertcdemo",["ionic","ui.router","config","btford.socket-io"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("app",{url:"/app","abstract":!0,templateUrl:"templates/app.html"}).state("app.login",{url:"/login",controller:"LoginCtrl",templateUrl:"templates/login.html"}).state("app.contacts",{url:"/contacts",controller:"ContactsCtrl",templateUrl:"templates/contacts.html"}).state("app.call",{url:"/call/:contactName?isCalling",controller:"CallCtrl",templateUrl:"templates/call.html"}),b.otherwise("/app/login")}]).run(["$ionicPlatform",function(a){a.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}]).run(["$state","signaling",function(a,b){b.on("messageReceived",function(b,c){switch(c.type){case"call":if("app.call"===a.current.name)return;a.go("app.call",{isCalling:!1,contactName:b})}})}]),angular.module("phonertcdemo").factory("signaling",["socketFactory",function(a){var b=io.connect("http://192.168.1.100:3000/"),a=a({ioSocket:b});return a}]),angular.module("phonertcdemo").factory("ContactsService",["signaling",function(a){var b=[];return a.on("online",function(a){-1===b.indexOf(a)&&b.push(a)}),a.on("offline",function(a){var c=b.indexOf(a);-1!==c&&b.splice(c,1)}),{onlineUsers:b,setOnlineUsers:function(a,c){this.currentName=c,b.length=0,a.forEach(function(a){a!==c&&b.push(a)})}}}]),angular.module("phonertcdemo").controller("LoginCtrl",["$scope","$state","$ionicPopup","signaling","ContactsService",function(a,b,c,d,e){a.data={},a.loading=!1,a.login=function(){a.loading=!0,d.emit("login",a.data.name)},d.on("login_error",function(b){a.loading=!1;c.alert({title:"Error",template:b})}),d.on("login_successful",function(c){e.setOnlineUsers(c,a.data.name),b.go("app.contacts")})}]),angular.module("phonertcdemo").controller("ContactsCtrl",["$scope","ContactsService",function(a,b){a.contacts=b.onlineUsers}]),angular.module("phonertcdemo").controller("CallCtrl",["$scope","$state","$rootScope","$timeout","$ionicModal","$stateParams","signaling","ContactsService",function(a,b,c,d,e,f,g,h){function i(c,d){console.log((new Date).toString()+": calling to "+d+", isInitiator: "+c);var e={isInitiator:c,turn:{host:"turn:ec2-54-68-238-149.us-west-2.compute.amazonaws.com:3478",username:"test",password:"test"},streams:{audio:!0,video:!0}},f=new cordova.plugins.phonertc.Session(e);f.on("sendMessage",function(a){g.emit("sendMessage",d,{type:"phonertc_handshake",data:JSON.stringify(a)})}),f.on("answer",function(){console.log("Answered!")}),f.on("disconnect",function(){a.contacts[d]&&delete a.contacts[d],0===Object.keys(a.contacts).length&&(g.emit("sendMessage",d,{type:"ignore"}),b.go("app.contacts"))}),f.call(),a.contacts[d]=f}function j(c,e){switch(e.type){case"answer":a.$apply(function(){a.callInProgress=!0,d(a.updateVideoPosition,1e3)});var f=Object.keys(a.contacts);0!==f.length&&g.emit("sendMessage",c,{type:"add_to_group",contacts:f,isInitiator:!1}),i(!0,c);break;case"ignore":var j=Object.keys(a.contacts).length;if(j>0){a.contacts[c]&&(a.contacts[c].close(),delete a.contacts[c]);var l=a.hideFromContactList.indexOf(c);l>-1&&a.hideFromContactList.splice(l,1),0===Object.keys(a.contacts).length&&b.go("app.contacts")}else b.go("app.contacts");break;case"phonertc_handshake":-1===k.indexOf(e.data)&&(a.contacts[c].receiveMessage(JSON.parse(e.data)),k.push(e.data));break;case"add_to_group":e.contacts.forEach(function(b){a.hideFromContactList.push(b),i(e.isInitiator,b),e.isInitiator||d(function(){g.emit("sendMessage",b,{type:"add_to_group",contacts:[h.currentName],isInitiator:!0})},1500)})}}var k=[];a.callInProgress=!1,a.isCalling="true"===f.isCalling,a.contactName=f.contactName,a.allContacts=h.onlineUsers,a.contacts={},a.hideFromContactList=[a.contactName],a.muted=!1,e.fromTemplateUrl("templates/select_contact.html",{scope:a,animation:"slide-in-up"}).then(function(b){a.selectContactModal=b}),a.isCalling&&g.emit("sendMessage",f.contactName,{type:"call"}),a.ignore=function(){var c=Object.keys(a.contacts);c.length>0?a.contacts[c[0]].disconnect():(g.emit("sendMessage",f.contactName,{type:"ignore"}),b.go("app.contacts"))},a.end=function(){Object.keys(a.contacts).forEach(function(b){a.contacts[b].close(),delete a.contacts[b]})},a.answer=function(){a.callInProgress||(a.callInProgress=!0,d(a.updateVideoPosition,1e3),i(!1,f.contactName),setTimeout(function(){console.log("sending answer"),g.emit("sendMessage",f.contactName,{type:"answer"})},1500))},a.updateVideoPosition=function(){c.$broadcast("videoView.updatePosition")},a.openSelectContactModal=function(){cordova.plugins.phonertc.hideVideoView(),a.selectContactModal.show()},a.closeSelectContactModal=function(){cordova.plugins.phonertc.showVideoView(),a.selectContactModal.hide()},a.addContact=function(b){a.hideFromContactList.push(b),g.emit("sendMessage",b,{type:"call"}),cordova.plugins.phonertc.showVideoView(),a.selectContactModal.hide()},a.hideCurrentUsers=function(){return function(b){return-1===a.hideFromContactList.indexOf(b)}},a.toggleMute=function(){a.muted=!a.muted,Object.keys(a.contacts).forEach(function(b){var c=a.contacts[b];c.streams.audio=!a.muted,c.renegotiate()})},g.on("messageReceived",j),a.$on("$destroy",function(){g.removeListener("messageReceived",j)})}]),angular.module("phonertcdemo").directive("videoView",["$rootScope","$timeout",function(a,b){return{restrict:"E",template:'<div class="video-container"></div>',replace:!0,link:function(c,d,e){function f(){cordova.plugins.phonertc.setVideoView({container:d[0],local:{position:[240,240],size:[50,50]}})}b(f,500),a.$on("videoView.updatePosition",f)}}}]);